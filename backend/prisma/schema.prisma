// WhatsApp Personal CRM - Prisma Schema
// See docs/implementation-plan.md for full context

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // DATABASE_URL is set in prisma.config.ts (Prisma 7)
}

model User {
  id              String            @id @default(cuid())
  email           String            @unique
  passwordHash    String
  name            String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  whatsAppSession WhatsAppSession?
  contacts        Contact[]
  messages        Message[]

  @@map("users")
}

model WhatsAppSession {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  phoneNumber   String?
  isConnected   Boolean   @default(false)
  lastConnected DateTime?
  qrCode        String?   // Temporary storage for QR during pairing

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("whatsapp_sessions")
}

model Contact {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  whatsappId      String    // Format: 1234567890@s.whatsapp.net
  name            String?   // From WhatsApp profile
  pushName        String?   // Display name
  phoneNumber     String?
  profilePicUrl   String?

  isGroup         Boolean   @default(false)

  // CRM fields
  lastInteraction DateTime?
  notes           String?
  tags           String[]  // Array of tags

  // NEW: Predefined enrichment fields
  birthday        DateTime?
  company         String?
  jobTitle        String?
  location        String?

  // NEW: Relationship metadata
  relationshipType String?  // "family", "close_friend", "colleague", "acquaintance"
  contactFrequency String?  // "daily", "weekly", "monthly", "quarterly"
  importance      Int?      @default(0) // 0-5 scale

  // NEW: Custom fields (JSONB for flexibility)
  customFields    Json?     @db.JsonB

  // NEW: Interaction stats (computed/cached)
  interactionCount7d  Int? @default(0)
  interactionCount30d Int? @default(0)
  interactionCount90d Int? @default(0)

  messages        Message[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, whatsappId])
  @@index([userId, lastInteraction])
  @@index([userId, relationshipType])
  @@map("contacts")
}

model Message {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  contactId   String
  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  whatsappId  String      @unique // Message ID from WhatsApp

  fromMe      Boolean     // True if sent by user, false if received
  body        String?     // Text content
  timestamp   DateTime

  // Message type
  type        MessageType @default(TEXT)

  // Reply-to (quoted)
  quotedMessageId String?
  quotedMessage   Message?  @relation("MessageReplies", fields: [quotedMessageId], references: [id])
  replies        Message[] @relation("MessageReplies")
  quotedContent  String?   // Denormalized text for display

  // Group sender identity
  senderJid   String?     // In groups: participant JID
  senderName  String?     // pushName at time of send
  senderPhone String?

  // Media
  hasMedia    Boolean   @default(false)
  mediaUrl    String?   // Local path or S3 URL
  mediaMimeType String?
  mediaSize   Int?

  // Metadata
  isRead      Boolean   @default(false)
  isDeleted   Boolean   @default(false)

  reactions   Reaction[]

  createdAt   DateTime  @default(now())

  @@index([userId, contactId, timestamp])
  @@index([userId, timestamp])
  @@map("messages")
}

model Reaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  emoji     String
  fromMe    Boolean
  timestamp DateTime @default(now())

  @@unique([messageId, fromMe])
  @@index([messageId])
  @@map("reactions")
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  STICKER
  LOCATION
  CONTACT
  OTHER
}
